import { Directive, inject, effect, runInInjectionContext, NgZone, Injector, Renderer2, PLATFORM_ID } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { NG_SCROLLBAR } from 'ngx-scrollbar';
import * as i0 from "@angular/core";
export class ReachedDroppedBase {
    constructor() {
        this.isBrowser = isPlatformBrowser(inject(PLATFORM_ID));
        this.zone = inject(NgZone);
        this.renderer = inject(Renderer2);
        this.injector = inject(Injector);
        this.scrollbar = inject(NG_SCROLLBAR);
        /** An array that contains all trigger elements  **/
        this.triggerElements = [];
        /** An array that contains the chosen outputs */
        this.subscribedEvents = [];
        /** A mapper function to ease forwarding the intersected element to its proper output */
        this.eventActions = {
            top: { emit: () => this.scrollbar.isVerticallyScrollable() ? this.top.emit() : null },
            bottom: { emit: () => this.scrollbar.isVerticallyScrollable() ? this.bottom.emit() : null },
            start: { emit: () => this.scrollbar.isHorizontallyScrollable() ? this.start.emit() : null },
            end: { emit: () => this.scrollbar.isHorizontallyScrollable() ? this.end.emit() : null }
        };
    }
    onAction(trigger) {
        if (trigger) {
            this.eventActions[trigger]?.emit();
        }
    }
    setCssVariable(property, value) {
        if (value) {
            this.scrollbar.nativeElement.style.setProperty(property, `${value}px`);
        }
    }
    activate() {
        this.zone.runOutsideAngular(() => {
            // Create the scrollbars element inside the viewport
            this.triggerElementsWrapper = this.renderer.createElement('div');
            this.renderer.addClass(this.triggerElementsWrapper, this.triggerElementsWrapperClass);
            this.renderer.appendChild(this.scrollbar.viewport.contentWrapperElement, this.triggerElementsWrapper);
            // Create a trigger element for each subscribed event
            this.subscribedEvents.forEach((event) => {
                const triggerElement = this.renderer.createElement('div');
                this.renderer.addClass(triggerElement, this.triggerElementClass);
                this.renderer.setAttribute(triggerElement, 'trigger', event);
                this.renderer.appendChild(this.triggerElementsWrapper, triggerElement);
                this.triggerElements.push(triggerElement);
            });
            // The first time the observer is triggered as soon as the element is observed,
            // This flag is used to ignore this first trigger
            let intersectionObserverInit = false;
            this.intersectionObserver = new IntersectionObserver((entries) => {
                if (intersectionObserverInit) {
                    entries.forEach((entry) => {
                        if (this.isTriggered(entry)) {
                            // Forward the detected trigger element only after the observer is initialized
                            // Only observe the trigger elements when scrollable
                            this.zone.run(() => this.onAction(entry.target.getAttribute('trigger')));
                        }
                    });
                }
                else {
                    // Once the initial element is detected set a flag to true
                    intersectionObserverInit = true;
                }
            }, {
                root: this.scrollbar.viewport.nativeElement,
            });
            this.triggerElements.forEach((el) => this.intersectionObserver.observe(el));
        });
    }
    deactivate() {
        this.intersectionObserver?.disconnect();
        this.triggerElementsWrapper?.remove();
        this.triggerElements = [];
    }
    ngOnInit() {
        if (this.top.observed) {
            this.subscribedEvents.push('top');
        }
        if (this.bottom.observed) {
            this.subscribedEvents.push('bottom');
        }
        if (this.start.observed) {
            this.subscribedEvents.push('start');
        }
        if (this.end.observed) {
            this.subscribedEvents.push('end');
        }
        runInInjectionContext(this.injector, () => {
            effect(() => {
                if (this.disabled()) {
                    this.deactivate();
                }
                else {
                    if (this.isBrowser) {
                        this.activate();
                    }
                }
            });
        });
    }
    ngOnDestroy() {
        this.deactivate();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.3", ngImport: i0, type: ReachedDroppedBase, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "17.3.3", type: ReachedDroppedBase, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.3", ngImport: i0, type: ReachedDroppedBase, decorators: [{
            type: Directive
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhY2hlZC1kcm9wcGVkLWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3JlYWNoZWQtZXZlbnQvc3JjL3JlYWNoZWQtZHJvcHBlZC1iYXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsTUFBTSxFQUNOLE1BQU0sRUFDTixxQkFBcUIsRUFHckIsTUFBTSxFQUNOLFFBQVEsRUFDUixTQUFTLEVBRVQsV0FBVyxFQUVaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sRUFBZ0IsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDOztBQU8zRCxNQUFNLE9BQWdCLGtCQUFrQjtJQUR4QztRQUdxQixjQUFTLEdBQVksaUJBQWlCLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFFNUQsU0FBSSxHQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU5QixhQUFRLEdBQWMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXhDLGFBQVEsR0FBYSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFdEMsY0FBUyxHQUFpQixNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFbEUsb0RBQW9EO1FBQzFDLG9CQUFlLEdBQWtCLEVBQUUsQ0FBQztRQUs5QyxnREFBZ0Q7UUFDdEMscUJBQWdCLEdBQWEsRUFBRSxDQUFDO1FBdUIxQyx3RkFBd0Y7UUFDL0UsaUJBQVksR0FBZ0M7WUFDbkQsR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQzNGLE1B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SSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNuQztRQUVELHFCQUFxQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7Z0JBQ1YsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUU7b0JBQ25CLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztpQkFDbkI7cUJBQU07b0JBQ0wsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO3dCQUNsQixJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7cUJBQ2pCO2lCQUNGO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQ3BCLENBQUM7OEdBMUltQixrQkFBa0I7a0dBQWxCLGtCQUFrQjs7MkZBQWxCLGtCQUFrQjtrQkFEdkMsU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgRGlyZWN0aXZlLFxyXG4gIGluamVjdCxcclxuICBlZmZlY3QsXHJcbiAgcnVuSW5JbmplY3Rpb25Db250ZXh0LFxyXG4gIE9uSW5pdCxcclxuICBPbkRlc3Ryb3ksXHJcbiAgTmdab25lLFxyXG4gIEluamVjdG9yLFxyXG4gIFJlbmRlcmVyMixcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgUExBVEZPUk1fSUQsXHJcbiAgSW5wdXRTaWduYWxXaXRoVHJhbnNmb3JtXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgX05nU2Nyb2xsYmFyLCBOR19TQ1JPTExCQVIgfSBmcm9tICduZ3gtc2Nyb2xsYmFyJztcclxuXHJcbnR5cGUgRXZlbnRBY3Rpb24gPSB7XHJcbiAgZW1pdDogKCkgPT4gdm9pZDtcclxufVxyXG5cclxuQERpcmVjdGl2ZSgpXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZWFjaGVkRHJvcHBlZEJhc2UgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gIHByb3RlY3RlZCByZWFkb25seSBpc0Jyb3dzZXI6IGJvb2xlYW4gPSBpc1BsYXRmb3JtQnJvd3NlcihpbmplY3QoUExBVEZPUk1fSUQpKTtcclxuXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHpvbmU6IE5nWm9uZSA9IGluamVjdChOZ1pvbmUpO1xyXG5cclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgcmVuZGVyZXI6IFJlbmRlcmVyMiA9IGluamVjdChSZW5kZXJlcjIpO1xyXG5cclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgaW5qZWN0b3I6IEluamVjdG9yID0gaW5qZWN0KEluamVjdG9yKTtcclxuXHJcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IHNjcm9sbGJhcjogX05nU2Nyb2xsYmFyID0gaW5qZWN0KE5HX1NDUk9MTEJBUik7XHJcblxyXG4gIC8qKiBBbiBhcnJheSB0aGF0IGNvbnRhaW5zIGFsbCB0cmlnZ2VyIGVsZW1lbnRzICAqKi9cclxuICBwcm90ZWN0ZWQgdHJpZ2dlckVsZW1lbnRzOiBIVE1MRWxlbWVudFtdID0gW107XHJcblxyXG4gIC8qKiBUaGUgaW50ZXJzZWN0aW9uIG9ic2VydmVyIHJlZmVyZW5jZSAqL1xyXG4gIHByb3RlY3RlZCBpbnRlcnNlY3Rpb25PYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXI7XHJcblxyXG4gIC8qKiBBbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSBjaG9zZW4gb3V0cHV0cyAqL1xyXG4gIHByb3RlY3RlZCBzdWJzY3JpYmVkRXZlbnRzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAvKiogVGhlIHdyYXBwZXIgZWxlbWVudCB0aGF0IGNvbnRhaW5zIHRoZSB0cmlnZ2VyIGVsZW1lbnRzICovXHJcbiAgcHJvdGVjdGVkIHRyaWdnZXJFbGVtZW50c1dyYXBwZXI6IEhUTUxFbGVtZW50O1xyXG5cclxuICAvKiogVGhlIHdyYXBwZXIgZWxlbWVudCBjbGFzcyBuYW1lICovXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHRyaWdnZXJFbGVtZW50c1dyYXBwZXJDbGFzczogc3RyaW5nO1xyXG5cclxuICAvKiogVGhlIHRyaWdnZXIgZWxlbWVudCBjbGFzcyBuYW1lICovXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHRyaWdnZXJFbGVtZW50Q2xhc3M6IHN0cmluZztcclxuXHJcbiAgYWJzdHJhY3QgZGlzYWJsZWQ6IElucHV0U2lnbmFsV2l0aFRyYW5zZm9ybTxib29sZWFuLCBzdHJpbmcgfCBib29sZWFuPjtcclxuXHJcbiAgYWJzdHJhY3QgdG9wOiBFdmVudEVtaXR0ZXI8dm9pZD47XHJcblxyXG4gIGFic3RyYWN0IGJvdHRvbTogRXZlbnRFbWl0dGVyPHZvaWQ+O1xyXG5cclxuICBhYnN0cmFjdCBzdGFydDogRXZlbnRFbWl0dGVyPHZvaWQ+O1xyXG5cclxuICBhYnN0cmFjdCBlbmQ6IEV2ZW50RW1pdHRlcjx2b2lkPjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGlzVHJpZ2dlcmVkKGVudHJ5OiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5KTogYm9vbGVhbjtcclxuXHJcbiAgLyoqIEEgbWFwcGVyIGZ1bmN0aW9uIHRvIGVhc2UgZm9yd2FyZGluZyB0aGUgaW50ZXJzZWN0ZWQgZWxlbWVudCB0byBpdHMgcHJvcGVyIG91dHB1dCAqL1xyXG4gIHJlYWRvbmx5IGV2ZW50QWN0aW9uczogUmVjb3JkPHN0cmluZywgRXZlbnRBY3Rpb24+ID0ge1xyXG4gICAgdG9wOiB7IGVtaXQ6ICgpOiB2b2lkID0+IHRoaXMuc2Nyb2xsYmFyLmlzVmVydGljYWxseVNjcm9sbGFibGUoKSA/IHRoaXMudG9wLmVtaXQoKSA6IG51bGwgfSxcclxuICAgIGJvdHRvbTogeyBlbWl0OiAoKTogdm9pZCA9PiB0aGlzLnNjcm9sbGJhci5pc1ZlcnRpY2FsbHlTY3JvbGxhYmxlKCkgPyB0aGlzLmJvdHRvbS5lbWl0KCkgOiBudWxsIH0sXHJcbiAgICBzdGFydDogeyBlbWl0OiAoKTogdm9pZCA9PiB0aGlzLnNjcm9sbGJhci5pc0hvcml6b250YWxseVNjcm9sbGFibGUoKSA/IHRoaXMuc3RhcnQuZW1pdCgpIDogbnVsbCB9LFxyXG4gICAgZW5kOiB7IGVtaXQ6ICgpOiB2b2lkID0+IHRoaXMuc2Nyb2xsYmFyLmlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZSgpID8gdGhpcy5lbmQuZW1pdCgpIDogbnVsbCB9XHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSBvbkFjdGlvbih0cmlnZ2VyOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0cmlnZ2VyKSB7XHJcbiAgICAgIHRoaXMuZXZlbnRBY3Rpb25zW3RyaWdnZXJdPy5lbWl0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc2V0Q3NzVmFyaWFibGUocHJvcGVydHk6IHN0cmluZywgdmFsdWU6IG51bWJlcik6IHZvaWQge1xyXG4gICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgIHRoaXMuc2Nyb2xsYmFyLm5hdGl2ZUVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkocHJvcGVydHksIGAkeyB2YWx1ZSB9cHhgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAvLyBDcmVhdGUgdGhlIHNjcm9sbGJhcnMgZWxlbWVudCBpbnNpZGUgdGhlIHZpZXdwb3J0XHJcbiAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnRzV3JhcHBlciA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy50cmlnZ2VyRWxlbWVudHNXcmFwcGVyLCB0aGlzLnRyaWdnZXJFbGVtZW50c1dyYXBwZXJDbGFzcyk7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5zY3JvbGxiYXIudmlld3BvcnQuY29udGVudFdyYXBwZXJFbGVtZW50LCB0aGlzLnRyaWdnZXJFbGVtZW50c1dyYXBwZXIpO1xyXG5cclxuICAgICAgLy8gQ3JlYXRlIGEgdHJpZ2dlciBlbGVtZW50IGZvciBlYWNoIHN1YnNjcmliZWQgZXZlbnRcclxuICAgICAgdGhpcy5zdWJzY3JpYmVkRXZlbnRzLmZvckVhY2goKGV2ZW50OiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCB0cmlnZ2VyRWxlbWVudDogSFRNTEVsZW1lbnQgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModHJpZ2dlckVsZW1lbnQsIHRoaXMudHJpZ2dlckVsZW1lbnRDbGFzcyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodHJpZ2dlckVsZW1lbnQsICd0cmlnZ2VyJywgZXZlbnQpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy50cmlnZ2VyRWxlbWVudHNXcmFwcGVyLCB0cmlnZ2VyRWxlbWVudCk7XHJcbiAgICAgICAgdGhpcy50cmlnZ2VyRWxlbWVudHMucHVzaCh0cmlnZ2VyRWxlbWVudCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgLy8gVGhlIGZpcnN0IHRpbWUgdGhlIG9ic2VydmVyIGlzIHRyaWdnZXJlZCBhcyBzb29uIGFzIHRoZSBlbGVtZW50IGlzIG9ic2VydmVkLFxyXG4gICAgICAvLyBUaGlzIGZsYWcgaXMgdXNlZCB0byBpZ25vcmUgdGhpcyBmaXJzdCB0cmlnZ2VyXHJcbiAgICAgIGxldCBpbnRlcnNlY3Rpb25PYnNlcnZlckluaXQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoKGVudHJpZXM6IEludGVyc2VjdGlvbk9ic2VydmVyRW50cnlbXSkgPT4ge1xyXG4gICAgICAgIGlmIChpbnRlcnNlY3Rpb25PYnNlcnZlckluaXQpIHtcclxuICAgICAgICAgIGVudHJpZXMuZm9yRWFjaCgoZW50cnk6IEludGVyc2VjdGlvbk9ic2VydmVyRW50cnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNUcmlnZ2VyZWQoZW50cnkpKSB7XHJcbiAgICAgICAgICAgICAgLy8gRm9yd2FyZCB0aGUgZGV0ZWN0ZWQgdHJpZ2dlciBlbGVtZW50IG9ubHkgYWZ0ZXIgdGhlIG9ic2VydmVyIGlzIGluaXRpYWxpemVkXHJcbiAgICAgICAgICAgICAgLy8gT25seSBvYnNlcnZlIHRoZSB0cmlnZ2VyIGVsZW1lbnRzIHdoZW4gc2Nyb2xsYWJsZVxyXG4gICAgICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4gdGhpcy5vbkFjdGlvbihlbnRyeS50YXJnZXQuZ2V0QXR0cmlidXRlKCd0cmlnZ2VyJykpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIE9uY2UgdGhlIGluaXRpYWwgZWxlbWVudCBpcyBkZXRlY3RlZCBzZXQgYSBmbGFnIHRvIHRydWVcclxuICAgICAgICAgIGludGVyc2VjdGlvbk9ic2VydmVySW5pdCA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LCB7XHJcbiAgICAgICAgcm9vdDogdGhpcy5zY3JvbGxiYXIudmlld3BvcnQubmF0aXZlRWxlbWVudCxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLnRyaWdnZXJFbGVtZW50cy5mb3JFYWNoKChlbDogSFRNTEVsZW1lbnQpID0+IHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIub2JzZXJ2ZShlbCkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRlYWN0aXZhdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyPy5kaXNjb25uZWN0KCk7XHJcbiAgICB0aGlzLnRyaWdnZXJFbGVtZW50c1dyYXBwZXI/LnJlbW92ZSgpO1xyXG4gICAgdGhpcy50cmlnZ2VyRWxlbWVudHMgPSBbXTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMudG9wLm9ic2VydmVkKSB7XHJcbiAgICAgIHRoaXMuc3Vic2NyaWJlZEV2ZW50cy5wdXNoKCd0b3AnKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmJvdHRvbS5vYnNlcnZlZCkge1xyXG4gICAgICB0aGlzLnN1YnNjcmliZWRFdmVudHMucHVzaCgnYm90dG9tJyk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5zdGFydC5vYnNlcnZlZCkge1xyXG4gICAgICB0aGlzLnN1YnNjcmliZWRFdmVudHMucHVzaCgnc3RhcnQnKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmVuZC5vYnNlcnZlZCkge1xyXG4gICAgICB0aGlzLnN1YnNjcmliZWRFdmVudHMucHVzaCgnZW5kJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcnVuSW5JbmplY3Rpb25Db250ZXh0KHRoaXMuaW5qZWN0b3IsICgpID0+IHtcclxuICAgICAgZWZmZWN0KCgpID0+IHtcclxuICAgICAgICBpZiAodGhpcy5kaXNhYmxlZCgpKSB7XHJcbiAgICAgICAgICB0aGlzLmRlYWN0aXZhdGUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKHRoaXMuaXNCcm93c2VyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZhdGUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGVhY3RpdmF0ZSgpO1xyXG4gIH1cclxufVxyXG4iXX0=